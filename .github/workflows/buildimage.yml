
name: Build Image and Publish to GCR

on:
     workflow_dispatch :
    # workflow_call:
         inputs:
            environment:
                type: string
                required: true
    #        branch:
    #             type: string
    #             required: true      

#on:
#  push:
#    branches: [ "Main-Prod" ]

env:
    DOCKER_IMAGE: sts-knowledgebase

jobs:

    build-image:

        runs-on: ubuntu-22.04
        name: Build & Publish Image
        
        steps:

            - name: Checkout Repository
              uses: actions/checkout@v3
              with:
                ref: ${{ github.ref }}

            - name: Get GitHub Runner IP
              id: whats-my-ip
              uses: ./.github/actions/whats-my-ip-address


            - name: GitHub Container Registry Login
              uses: docker/login-action@v3
              with:
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}

                                 
            - name: Bump version and push tag
              uses: mathieudutour/github-tag-action@v6.1
              id: tag_version
              with:
                 github_token: ${{ secrets.GITHUB_TOKEN }}

            - name: Create a GitHub release
              uses: ncipollo/release-action@v1
              with:
                tag: ${{ steps.tag_version.outputs.new_tag }}
                name: Release ${{ steps.tag_version.outputs.new_tag }}
                body: ${{ steps.tag_version.outputs.changelog }}    

            - name: Build Image & Publish To GCR
              uses: docker/build-push-action@v4
              with:
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}
                registry: docker.pkg.github.com
                context: ./
                file: ./src/App/Dockerfile
                build-args: COMMIT_SHA=${{ inputs.checked-out-sha }}
                #run: |
                #    docker build . --tag ghcr.io/dfe-digital/sts-knowledgebase/App:latest
                #    docker push ghcr.io/dfe-digital/sts-knowledgebase/App:latest
                tags: |
                    ghcr.io/dfe-digital/${{ env.DOCKER_IMAGE}}:${{ steps.tag_version.outputs.new_tag }}
                push: true

            #- name: Set Action Secret
            #  uses: action-pack/increment@v2
            #  with:
            #    name: 'PATCH_VERSION'
            #    token: ${{ secrets.REPO_ACCESS_TOKEN }}   
